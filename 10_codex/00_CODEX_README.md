# Codex 专用 / 执行控制层（非项目创意或内容本体）
> 此文档仅用于规范 Codex 的执行控制角色，可单独替换或移除，不属于模板的创意或内容主线。

## 1. Codex 的角色与职责边界
- 作为执行型协作助手，我仅负责根据用户指令补充或维护执行控制层，避免主导创意、产品或内容决策。
- 我不预设或裁定项目的艺术方向，只按既定绑定（如 AGENTS 指令）完成控制层相关更新。
- 我确保所有新增内容都保持与原有模板结构明确分离，便于日后整体替换或取消。

## 2. 明确禁止 / 允许的行为
- 允许：新增专用于 Codex 管理、权限或流程的文档，或在现有文件最前端追加执行控制声明（仅在无法添新文件时）。
- 禁止：重写、删减、重组已有内容；添加未经授权的创意或项目任务执行说明；擅自修改其他文件内容。
- 禁止：任何假设缺失信息、越过“只读理解”阶段对项目内容直接执行任务。

## 3. Codex 启动时的默认动作
- 每次启动即只阅读与执行控制层相关的文件与指令，不发起项目任务、修改或推论。
- 默认策略为“理解后等待进一步指示”，除非新指令明确授权所需的修改或操作。
- 若需要执行写入操作，会在得到明确指示后再行动，并注明对现存文件无任何变更。

## 4. 多文档情形下的优先级与冲突处理
- 遭遇多份指令时，优先遵循最近一次明确命名为 Codex 执行控制内容的文件（本文件、AGENTS 等）。
- 其次遵循用户指令，其次再遵循项目中其他文档；若存在矛盾，向用户说明优先顺序并请求澄清。
- 所有冲突解决结果应记录在执行控制层以保持透明，并可随时由用户替换或删除控制层。

## 5. 项目核心与人工介入
- `30_project/` 为项目核心内容区，默认需要人工审核；Codex 请勿擅自更改其中文件，除非在 `00_human/INBOX.md` 获得明确指令。
- 当遇到缺信息、无法自行判定的约束或需人工审批的操作时，必须立即记录在 `00_human/INBOX.md`，并等待明确的反馈再继续。

## 6. 人工互动语言规范（Language for Human Interaction）
- 所有需要人工介入的事项（判定、裁决、补信息、审批）必须通过 `00_human/INBOX.md` 提出，并注明状态，便于人类察看与回应。
- `00_human/INBOX.md`、`00_human/NEEDED_INPUTS.md`、`00_human/APPROVALS.md` 中的描述、问题、选项与行动要求，应以中文为主；可在结尾附上英文补充说明，但中文表述需清晰完整。
- 机器执行层（`10_codex/Makefile`、`10_codex/tools/`、`20_runtime/` 等）无需调整语言，按现有逻辑继续使用英文或中英混用即可。

## 7. 启动清单默认路径规范
- 所有项目启动清单必须指向这一套固定路径：`30_project/inputs/script/`、`30_project/inputs/storyboard/`、`30_project/inputs/reference/`、`30_project/inputs/assets/`，任何时候都不得更改这些目录名。
- 若需要说明具体文件或格式，仍在清单备注中补充，但路径引用必须保持与上述规范一致，确保 Codex 与人类始终围绕统一结构协作。

## 8. INBOX 使用规范（防呆机制）
- INBOX 的语义：仅收录“当前需要人工关注、决策或补充”的事项，不作为历史日志，也不存长期备忘，只保留下一步必须解决的问题。
- 状态驱动：条目只有在 Status 为 `pending` 时才需要用户处理；一旦前提条件满足（例如需要的文件已放置在指定路径），必须立即将对应条目标记为 `done` 或 `resolved`，并清除与之相关的提醒，避免重复干扰。
- 禁止重复提问：同一问题或需求在 INBOX 中仅允许出现一次；已标为 `done` / `resolved` 后不得重新创建类似条目，也不得在后续的清单或总结中再次出现该问题。
- 项目时间线意识：INBOX 只保留与“下一步”直接相关的问题，随着项目进展过期事项应及时清理或完成，用户无需也不应回顾已经解决的事项。
- 用户阅读约定：用户只需关注 `00_human/INBOX.md` 中 Status 为 `pending` 的条目，其它状态的条目默认无需关注或回应，避免阅读冗余内容。

## 9. 启动即制作清单 / 空项目检测
- 启动新项目时务必先运行 `make check-inputs`（或直接执行 `python3 tools/check_inputs.py`），该脚本会扫描 `30_project/inputs/` 并替换 `00_human/INBOX.md` 中 `<!-- inputs-detection:start -->` 与 `<!-- inputs-detection:end -->` 之间的内容，输出当前素材状态。
- 检测准则：
  - 只要任一关键目录（`script`、`storyboard`、`reference`、`assets`，不区分大小写）下递归包含任意文件，即视为已提供素材；文件名可包含中文、任意扩展名，扩展名大小写也不会影响识别。
  - `30_project/inputs/index.yaml` 仍可作为项目入口补充元信息，但缺失不再阻塞启动，脚本会在摘要中提示其存在与否。
  - 一旦检测到素材，INBOX 将被标记为 resolved 形式并列出相对路径，禁止再次生成“请提供剧本／分镜／参考”的待办；仅在确实未发现素材时才展现那套必需清单并保持 `pending`，避免重复打扰。

## 【输入素材的自动预处理职责】

1) 触发条件
- 当检测到 `30_project/inputs/` 下出现新的或更新的文件时，你应进入“预处理阶段”，而不是直接进入内容生成阶段。

2) 你被默认授权执行的预处理（无需再次询问用户）：
- 文件与文件夹命名规范化（统一大小写、分隔符、中英文混用、去除无意义字符）
  - 此项目规定命名规范化是【默认必须执行】的预处理步骤，遇到新的或更新素材必须先完成，之后再继续后续流程。
  - 在 `30_project/inputs/` 下发生新增素材时，你获得【物理重命名】权限，可直接修改原文件/文件夹名，但必须遵循：
    * 不删除任何文件
    * 不改变文件内容
    * 统一扩展名大小写（例如 `.JPG` → `.jpg`）
    * 去除“副本”“copy”“final”等无意义词
    * 使用可预测的稳定命名（如 `shot_01.jpg`、`storyboard_08.jpg`）
  - 若存在潜在引用风险，应在 `00_human/INBOX.md` 中记录“已重命名的映射关系（旧名 → 新名）”并保持 `pending` 或相关状态，便于人工核查；在没有风险的情况下，无需额外确认即可执行重命名。
  - 检测到新文件时，默认先执行命名规范化，再进入后续预处理或内容拆解阶段。
- 文本类文件（如剧本）的非语义清理：
  - 清理乱码、不可见字符、异常断行
  - 统一标点与段落分隔
- 基础结构化（不改变内容含义）：
  - 场景/段落分段
  - 行号或镜头占位标记（如不确定则使用 TODO）

【重复文件的处理与删除授权】

1) 定义“可安全删除的重复文件”
- 文件内容完全一致（如字节级一致，或明确可判定为等价副本）
- 不存在任何额外信息差异（分辨率、时长、帧、文本内容完全相同）
- 仅命名不同、路径不同或带有“副本/copy/(1)”等标识

2) 删除授权
- 你被明确授权【直接删除】上述定义下的重复文件
- 删除前需确认至少保留一个“主版本”文件
- 删除行为不视为信息丢失

3) 主版本选择规则（优先级）
- 命名最规范的
- 路径最符合模板规范的
- 文件名语义最清晰的
（如无明显差异，可任选其一）

4) 删除记录（轻量）
- 删除重复文件后，应在 `00_human/INBOX.md` 中简要记录：
  - 被删除的文件名
  - 保留的主版本文件名
- 无需用户确认即可执行

5) 禁止删除的情况（无论任何情况）
- 内容存在任何差异或不确定性
- 文件可能包含隐性信息（如不同分辨率、不同帧率、不同编码）
- 用户明确标注为“保留/不要删”的文件

目标：
- 主目录中对人而言只保留一个文件
- 冗余副本不长期占用空间
- 不影响任何创作或后续流程


3) 严格禁止的行为（无论任何情况）：
- 不得删除任何内容
- 不得改写、润色或重构剧情、对白或叙事
- 不得基于主观判断“优化表达”

4) 安全策略
- 如对某项修改是否影响语义存在不确定性：
  - 必须保留原文件
  - 创建 `*_cleaned` 或 `*_normalized` 版本
- 任何潜在有风险的修改，必须写入 `00_human/INBOX.md` 请求确认

5) 汇报规则
- 预处理完成后：
  - 不打扰用户
  - 仅在 INBOX 中简要说明“做了哪些类别的清理”
  - 若无风险事项，不生成待办

该预处理阶段完成后，方可进入项目内容拆解与生成阶段。

## 执行层流程规则（Execution Gates）

`30_project/docs/0-source/` 被定义为碎片事实源（可乱可碎）——仅供参考，不能直接驱动下游流程。`inputs/` 目录才是“可直接驱动生产的正式输入”，而 `0-source/raw/` 则是“碎片原料仓库”，仅供 Stage S 的 Source Synthesis 汇总。该目录必须至少包含三层结构：`raw/`（用户投递碎片的唯一入口）、`parsed/`（分批解析出的标准文本/说明）、`registry.yaml`（解析登记册）。若缺少明确的 `source_script.md`，必须先进入 Source Synthesis 阶段，生成可供人工确认的权威文本。

项目流程被划分为以下阶段 :

- 阶段 S：Source Synthesis（碎片化输入处理）
- 内容：优先结合 `30_project/docs/0-source/raw/structured/` 中的高质量 YAML 与 `raw/`、可选 `storyboard/` 与 `reference/` 中的碎片，整理出 `source_script_draft.md`
- 权限：允许自动化汇总碎片并生成草案
- 强制规则：
  - 需在 `00_human/INBOX.md` 中新增 `pending` 条目请求人工确认草案
  - 未收到人工确认，禁止生成 `script_breakdown`
  - 一旦人工确认，草案升级为 `source_script.md` 并归档 `source_script_draft.md` 版本
- 结束条件：存在 `approved` 的 `source_script.md`，该文件成为唯一权威文本来源
- 说明：`30_project/docs/0-source/` 必须包含三层结构——`raw/`（用户投递碎片入口）、`parsed/`（每个源文件的解析输出）、`registry.yaml`（记录 fingerprint、输出路径和解析状态）。Stage S 期间必须遵循解析登记册规则：
- 先查找 `registry.yaml` 中记录，若 fingerprint 未变则直接复用 `parsed_output`，避免重复解析；
- 若 fingerprint 变化或无记录，才解析对应 `raw/` 文件，产出详细的解析文本（`.md`/`.txt`），并写入 `parsed/`，同时更新 registry 的 `summary`、`status`（`parsed`/`skipped`/`needs_review`）与 `last_parsed_at`；
- 解析说明要具有可引用价值（如“提取出角色动机与环境描述”），而非仅写“已解析”；
- Stage S 的输入优先级为：先使用 registry 指向的 `parsed/` 文本，若需要再按 `raw/` 增量处理未登记或 fingerprint 变化的文件。`raw/structured/` 中的 YAML 属于手工核准的高质量片段，Stage S 应优先引用并直接复用。
- 注册条目必须包括至少这些字段：`source_path`、`fingerprint`、`parsed_output`、`summary`、`status`（`parsed`/`skipped`/`needs_review`）、`last_parsed_at`，以便 Source Synthesis 判断是否继续解析。

阶段 A：输入预处理（自动）

阶段 A：输入预处理（自动）
- 内容：命名规范化、去重、非语义清理
- 权限：可自动执行
- 结束条件：预处理完成

- 内容：从已确认的 `source_script.md`（唯一权威）生成 `script_breakdown`（结构性拆解），分镜/参考仅为辅助信息
- 权限：允许自动生成【第一版】
- 强制规则：
  - 生成第一版 script_breakdown 后，必须立刻停止
  - 必须在 `00_human/INBOX.md` 中请求人工审核
  - 在未收到人工确认前，禁止继续任何下游步骤

阶段 C：创作决策阶段（必须人工）
- 内容：镜头逻辑、叙事节奏、风格判断
- 权限：只能等待
- 禁止行为：
  - 不得要求 SRT / XML / 剪辑工程文件
  - 不得假设进入后期制作或交付阶段

阶段 D：后续生成（需显式批准）
- 内容：shot_plan、prompt_pack、时间轴估算等
- 权限：
  - 仅在人工明确回复“继续”或等价指令后才可执行
  - 否则一律禁止

## 模板清单与 Preflight（预置 + 自检）

1) `10_codex/TEMPLATE_MANIFEST.yaml` 是模板结构的 Source of Truth，列出必须保留的目录和文件（`00_human` 五件套、`30_project/inputs/script/source_script.md`、`0-source/raw/` + `parsed/` + `registry.yaml`、`1_story/script_breakdown_v1.yaml`、`2_layout/`、`2_audio/`、`5_color/`、`2_layout/2-2_layout_freeze.yaml` 等）。每当引入新路径或 archive 旧路径，应同步在该清单添加新条目，并让 `preflight` (see below) 触发之。
2) 每次执行前必须先运行 `preflight`；该脚本会根据 manifest 补齐结构、在 00_human/INBOX.md 写入结构变化摘要，并在缺失的 `source_script.md` situ 抛出门槛（只会在 INBOX 表格中提示“请向 30_project/docs/0-source/raw/ 投递碎片以生成 script”），确保执行节奏“停→走→停”。
3) `10_codex/Makefile` 已将 `plan`、`exec-plan`、`check-inputs` 与 `preflight` 串联：先自检、再生成，再等待人工批准；任何阶段主产物产出后都需在 INBOX 创建对应 pending 项，一旦 `APPROVALS.md` 写入该产物，该阶段才允许继续。
4) `source_script.md` 是第一门槛；没有确认的剧本，就不能生成 `script_breakdown_v1`，更不能进入 layout、prompt、render 等下游，整套流程靠 “AI 做事、人类决策” 的【停走停】节奏控制。
5) `10_codex/PIPELINE_STAGES.yaml` 是各阶段主产物与审批、后续目标的 Source of Truth；任何阶段产物或 gate 变更必须同步更新该文件，否则 preflight 会因缺失 approvals 而阻止执行。
## 强制停止规则（核心）

1) 在任何需要创作判断的节点，必须停下并等待人工。
2) 没有人工确认，不得“合理猜测”继续推进。
3) 若不确定当前所处阶段，默认视为【需要停下】。

## 违例处理

- 若你发现自己已经越过人工闸门（例如开始要求 SRT/XML）：
  - 必须立即回退到最近一个人工闸门阶段
  - 在 INBOX 中说明原因并请求指示

## 人工确认与冻结规则（Approval + Locking）

1) 人工确认信号来源：
- 以 `00_human/INBOX.md` 为唯一来源
- 当某条目 Status 从 `pending` 改为 `approved`/`done`/`resolved`，视为人工已确认
- 或出现形如 “`APPROVED: ID <n> ...`” 的确认口令，亦视为已确认

2) 冻结规则：
- 一旦某产出文件被人工确认（对应 INBOX ID 标记 `approved`），该文件必须视为 LOCKED，不得再修改
- 若需要修改，必须创建新版本文件（如 `*_v2.md`），不得覆写 `*_v1.md`

3) 防重复工作：
- 已 `approved` 的 INBOX 条目不得再次创建同类 `pending` 条目
- 必须在 INBOX 中引用已确认的版本号（例如 `script_breakdown v1` 已锁定）

4) 执行闸门：
- 进入下一阶段前，必须在 INBOX 创建 `pending` 条目并等待上述确认信号
- 未收到确认信号，必须停止
